#2SLS analysis 

#Read in relevant packages
library(ivreg)
library(dplyr)

#Read in data
data <- read.table("/projects/MRC-IEU/research/projects/ieu1/wp1/028/working/data/results/UKBB/Phenotypes/Platelet_phenotypes_and_medication/One_sample_MR/IEU_UKBB_plateletphenotypes_acuteMI_mortalityafterMI_DVT_PE_covariates_PC40_withIDS_onesampleMRinput_FINAL", header = T) 
PLT_PRS_SD <- read.table("/mnt/storage/scratch/ac14629/UKBB/Phenotypes/Platelet_phenotypes_and_medication/Input/PRS/HaemGen_PLT_PRS_chr1_22_input_FINAL", header = T)
MPV_PRS_SD <- read.table("/mnt/storage/scratch/ac14629/UKBB/Phenotypes/Platelet_phenotypes_and_medication/Input/PRS/HaemGen_MPV_PRS_chr1_22_input_FINAL", header = T) 

#Subset each exposures of interest with each outcome of interest, plus covariates and PC
t.plt.acuteMI <- data[c("FID", "IID", "PLT_initial_SD", "Acute_MI", "sex", "age_initialrecruitment", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "PC21", "PC22", "PC23", "PC24", "PC25", "PC26", "PC27", "PC28", "PC29", "PC30", "PC31", "PC32", "PC33", "PC34", "PC35", "PC36", "PC37", "PC38", "PC39", "PC40")]

t.plt.mortalityMI <- data[c("FID", "IID", "PLT_initial_SD", "Mortality_MI", "sex", "age_initialrecruitment", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "PC21", "PC22", "PC23", "PC24", "PC25", "PC26", "PC27", "PC28", "PC29", "PC30", "PC31", "PC32", "PC33", "PC34", "PC35", "PC36", "PC37", "PC38", "PC39", "PC40")]

t.plt.dvt <- data[c("FID", "IID", "PLT_initial_SD", "DVT", "sex", "age_initialrecruitment", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "PC21", "PC22", "PC23", "PC24", "PC25", "PC26", "PC27", "PC28", "PC29", "PC30", "PC31", "PC32", "PC33", "PC34", "PC35", "PC36", "PC37", "PC38", "PC39", "PC40")]

t.plt.pe <- data[c("FID", "IID", "PLT_initial_SD", "PE", "sex", "age_initialrecruitment", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "PC21", "PC22", "PC23", "PC24", "PC25", "PC26", "PC27", "PC28", "PC29", "PC30", "PC31", "PC32", "PC33", "PC34", "PC35", "PC36", "PC37", "PC38", "PC39", "PC40")]

t.mpv.acuteMI <- data[c("FID", "IID", "MPV_initial_SD", "Acute_MI", "sex", "age_initialrecruitment", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "PC21", "PC22", "PC23", "PC24", "PC25", "PC26", "PC27", "PC28", "PC29", "PC30", "PC31", "PC32", "PC33", "PC34", "PC35", "PC36", "PC37", "PC38", "PC39", "PC40")]

t.mpv.mortalityMI <- data[c("FID", "IID", "MPV_initial_SD", "Mortality_MI", "sex", "age_initialrecruitment", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "PC21", "PC22", "PC23", "PC24", "PC25", "PC26", "PC27", "PC28", "PC29", "PC30", "PC31", "PC32", "PC33", "PC34", "PC35", "PC36", "PC37", "PC38", "PC39", "PC40")]

t.mpv.dvt <- data[c("FID", "IID", "MPV_initial_SD", "DVT", "sex", "age_initialrecruitment", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "PC21", "PC22", "PC23", "PC24", "PC25", "PC26", "PC27", "PC28", "PC29", "PC30", "PC31", "PC32", "PC33", "PC34", "PC35", "PC36", "PC37", "PC38", "PC39", "PC40")]

t.mpv.pe <- data[c("FID", "IID", "MPV_initial_SD", "PE", "sex", "age_initialrecruitment", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "PC21", "PC22", "PC23", "PC24", "PC25", "PC26", "PC27", "PC28", "PC29", "PC30", "PC31", "PC32", "PC33", "PC34", "PC35", "PC36", "PC37", "PC38", "PC39", "PC40")]

#Subset each platelet PRS 
t.plt.prs.sd <- PLT_PRS_SD[c("FID", "IID", "PLT_PRS_SD")]
t.mpv.prs.sd <- MPV_PRS_SD[c("FID", "IID", "MPV_PRS_SD")] 

#Join the two datasets 
t.plt.acuteMI.prs <- inner_join(t.plt.acuteMI, t.plt.prs.sd, by = c("FID", "IID")) 
t.plt.mortalityMI.prs <- inner_join(t.plt.mortalityMI, t.plt.prs.sd, by = c("FID", "IID")) 
t.plt.dvt.prs <- inner_join(t.plt.dvt, t.plt.prs.sd, by = c("FID", "IID")) 
t.plt.pe.prs <- inner_join(t.plt.pe, t.plt.prs.sd, by = c("FID", "IID")) 
t.mpv.acuteMI.prs <- inner_join(t.mpv.acuteMI, t.mpv.prs.sd, by = c("FID", "IID")) 
t.mpv.mortalityMI.prs <- inner_join(t.mpv.mortalityMI, t.mpv.prs.sd, by = c("FID", "IID")) 
t.mpv.dvt.prs <- inner_join(t.mpv.dvt, t.mpv.prs.sd, by = c("FID", "IID")) 
t.mpv.pe.prs <- inner_join(t.mpv.pe, t.mpv.prs.sd, by = c("FID", "IID")) 

#Remove NAs from each subsetted dataframe
t.plt.acuteMI.prs <- na.omit(t.plt.acuteMI)
t.plt.mortalityMI.prs <- na.omit(t.plt.mortalityMI)
t.plt.dvt.prs <- na.omit(t.plt.dvt)
t.plt.pe.prs <- na.omit(t.plt.pe)
t.mpv.acuteMI.prs <- na.omit(t.mpv.acuteMI)
t.mpv.mortalityMI.prs <- na.omit(t.mpv.mortalityMI)
t.mpv.dvt.prs <- na.omit(t.mpv.dvt)
t.mpv.pe.prs <- na.omit(t.mpv.pe)

#2SLS analyses - Binary outcome - UK Biobank Overall
#In a two-stage analysis using a binary outcome (case-control setting) requires use of logistic regression with the inference on the controls only (where Y = 0). This can be performed by sequential regression using the 'predict' function 

#Acute MI on platelet count 
g = t.plt.acuteMI.prs$PLT_PRS_SD

g0=g[t.plt.acuteMI.prs$Acute_MI==0]

ivmodel.PLT.acuteMI <- glm(Acute_MI ~ predict(lm(PLT_initial_SD[Acute_MI==0]~g0 + age_initialrecruitment + sex + PC1 + PC2 + PC3 + PC4 + PC5 + PC6 + PC7 + PC8 + PC9 + PC10 + PC11 + PC12 + PC13 + PC14 + PC15 + PC16 + PC17 + PC18 + PC19 + PC20 + PC21 + PC22 + PC23 + PC24 + PC25 + PC26 + PC27 + PC28 + PC29 + PC30 + PC31 + PC32 + PC33 + PC34 + PC35 + PC36 + PC37 + PC38 + PC39 + PC40), newdata=list(g0=g)), data = t.plt.acuteMI.prs, family = "binomial")

ivmodel.PLT.acuteMI <- glm(t.plt.acuteMI.prs$Acute_MI ~ predict(lm(t.plt.acuteMI.prs$PLT_initial_SD[t.plt.acuteMI.prs$Acute_MI==0]~g0 + t.plt.acuteMI.prs$age_initialrecruitment + t.plt.acuteMI.prs$sex + t.plt.acuteMI.prs$PC1 + t.plt.acuteMI.prs$PC2 + t.plt.acuteMI.prs$PC3 + t.plt.acuteMI.prs$PC4 + t.plt.acuteMI.prs$PC5 + t.plt.acuteMI.prs$PC6 + t.plt.acuteMI.prs$PC7 + t.plt.acuteMI.prs$PC8 + t.plt.acuteMI.prs$PC9 + t.plt.acuteMI.prs$PC10 + t.plt.acuteMI.prs$PC11 + t.plt.acuteMI.prs$PC12 + t.plt.acuteMI.prs$PC13 + t.plt.acuteMI.prs$PC14 + t.plt.acuteMI.prs$PC15 + t.plt.acuteMI.prs$PC16 + t.plt.acuteMI.prs$PC17 + t.plt.acuteMI.prs$PC18 + t.plt.acuteMI.prs$PC19 + t.plt.acuteMI.prs$PC20 + t.plt.acuteMI.prs$PC21 + t.plt.acuteMI.prs$PC22 + t.plt.acuteMI.prs$PC23 + t.plt.acuteMI.prs$PC24 + t.plt.acuteMI.prs$PC25 + t.plt.acuteMI.prs$PC26 + t.plt.acuteMI.prs$PC27 + t.plt.acuteMI.prs$PC28 + t.plt.acuteMI.prs$PC29 + t.plt.acuteMI.prs$PC30 + t.plt.acuteMI.prs$PC31 + t.plt.acuteMI.prs$PC32 + t.plt.acuteMI.prs$PC33 + t.plt.acuteMI.prs$PC34 + t.plt.acuteMI.prs$PC35 + t.plt.acuteMI.prs$PC36 + t.plt.acuteMI.prs$PC37 + t.plt.acuteMI.prs$PC38 + t.plt.acuteMI.prs$PC39 + t.plt.acuteMI.prs$PC40) + t.plt.acuteMI.prs$age_initialrecruitment + t.plt.acuteMI.prs$sex + t.plt.acuteMI.prs$PC1 + t.plt.acuteMI.prs$PC2 + t.plt.acuteMI.prs$PC3 + t.plt.acuteMI.prs$PC4 + t.plt.acuteMI.prs$PC5 + t.plt.acuteMI.prs$PC6 + t.plt.acuteMI.prs$PC7 + t.plt.acuteMI.prs$PC8 + t.plt.acuteMI.prs$PC9 + t.plt.acuteMI.prs$PC10 + t.plt.acuteMI.prs$PC11 + t.plt.acuteMI.prs$PC12 + t.plt.acuteMI.prs$PC13 + t.plt.acuteMI.prs$PC14 + t.plt.acuteMI.prs$PC15 + t.plt.acuteMI.prs$PC16 + t.plt.acuteMI.prs$PC17 + t.plt.acuteMI.prs$PC18 + t.plt.acuteMI.prs$PC19 + t.plt.acuteMI.prs$PC20 + t.plt.acuteMI.prs$PC21 + t.plt.acuteMI.prs$PC22 + t.plt.acuteMI.prs$PC23 + t.plt.acuteMI.prs$PC24 + t.plt.acuteMI.prs$PC25 + t.plt.acuteMI.prs$PC26 + t.plt.acuteMI.prs$PC27 + t.plt.acuteMI.prs$PC28 + t.plt.acuteMI.prs$PC29 + t.plt.acuteMI.prs$PC30 + t.plt.acuteMI.prs$PC31 + t.plt.acuteMI.prs$PC32 + t.plt.acuteMI.prs$PC33 + t.plt.acuteMI.prs$PC34 + t.plt.acuteMI.prs$PC35 + t.plt.acuteMI.prs$PC36 + t.plt.acuteMI.prs$PC37 + t.plt.acuteMI.prs$PC38 + t.plt.acuteMI.prs$PC39 + t.plt.acuteMI.prs$PC40, newdata=list(g0=g)), family = binomial)

summary(ivmodel.PLT.acuteMI)
summary(ivmodel.PLT.acuteMI)$coef[2] # 2SLS estimate 
summary(ivmodel.PLT.acuteMI)$coef[2,2] # Standard error of 2SLS estimate 

#Mortality after MI on platelet count 
g = t.plt.mortalityMI.prs$PLT_PRS_SD 

g0=g[t.plt.mortalityMI.prs$Mortality_MI==0]

ivmodel.PLT.mortalityMI <- glm(t.plt.mortalityMI.prs$Mortality_MI ~ predict(lm(t.plt.mortalityMI.prs$PLT_initial_SD[t.plt.mortalityMI.prs$Mortality_MI==0]~g0), newdata=list(g0=g)), family = binomial)

summary(ivmodel.PLT.mortalityMI)
summary(ivmodel.PLT.mortalityMI)$coef[2] # 2SLS estimate 
summary(ivmodel.PLT.mortalityMI)$coef[2,2] # Standard error of 2SLS estimate 

#DVT on platelet count 
g = t.plt.dvt.prs$PLT_PRS_SD 

g0=g[t.plt.dvt.prs$DVT==0]

ivmodel.PLT.DVT <- glm(t.plt.dvt.prs$DVT ~ predict(lm(t.plt.dvt.prs$PLT_initial_SD[t.plt.dvt.prs$DVT==0]~g0), newdata=list(g0=g)), family = binomial)

summary(ivmodel.PLT.DVT)
summary(ivmodel.PLT.DVT)$coef[2] # 2SLS estimate 
summary(ivmodel.PLT.DVT)$coef[2,2] # Standard error of 2SLS estimate 

#PE on platelet count 
g = t.plt.pe.prs$PLT_PRS_SD 

g0=g[t.plt.pe.prs$PE==0]

ivmodel.PLT.PE <- glm(t.plt.pe.prs$PE ~ predict(lm(t.plt.pe.prs$PLT_initial_SD[t.plt.pe.prs$PE==0]~g0), newdata=list(g0=g)), family = binomial)

summary(ivmodel.PLT.PE)
summary(ivmodel.PLT.PE)$coef[2] # 2SLS estimate 
summary(ivmodel.PLT.PE)$coef[2,2] # Standard error of 2SLS estimate

#Acute MI on mean platelet volume 
g = t.mpv.acuteMI.prs$MPV_PRS_SD 

g0=g[t.mpv.acuteMI.prs$Acute_MI==0]

ivmodel.MPV.acuteMI <- glm(t.mpv.acuteMI.prs$Acute_MI ~ predict(lm(t.mpv.acuteMI.prs$MPV_initial_SD[t.mpv.acuteMI.prs$Acute_MI==0]~g0), newdata=list(g0=g)), family = binomial)

summary(ivmodel.MPV.acuteMI)
summary(ivmodel.MPV.acuteMI)$coef[2] # 2SLS estimate 
summary(ivmodel.MPV.acuteMI)$coef[2,2] # Standard error of 2SLS estimate

#Mortality after MI on mean platelet volume 
g = t.mpv.mortalityMI.prs$MPV_PRS_SD 

g0=g[t.mpv.mortalityMI.prs$Mortality_MI==0]

ivmodel.MPV.mortalityMI <- glm(t.mpv.mortalityMI.prs$Mortality_MI ~ predict(lm(t.mpv.mortalityMI.prs$MPV_initial_SD[t.mpv.mortalityMI.prs$Mortality_MI==0]~g0), newdata=list(g0=g)), family = binomial)

summary(ivmodel.MPV.mortalityMI)
summary(ivmodel.MPV.mortalityMI)$coef[2] # 2SLS estimate 
summary(ivmodel.MPV.mortalityMI)$coef[2,2] # Standard error of 2SLS estimate

#DVT on mean platelet volume 
g = t.mpv.dvt.MPVPRS$MPV_PRS 

g0=g[t.mpv.dvt.MPVPRS$DVT==0]

ivmodel.MPV.DVT <- glm(t.mpv.dvt.MPVPRS$DVT ~ predict(lm(t.mpv.dvt.MPVPRS$MPV_initial_SD[t.mpv.dvt.MPVPRS$DVT==0]~g0), newdata=list(g0=g)), family = binomial)

summary(ivmodel.MPV.DVT)
summary(ivmodel.MPV.DVT)$coef[2] # 2SLS estimate 
summary(ivmodel.MPV.DVT)$coef[2,2] # Standard error of 2SLS estimate

#PE on mean platelet volume 
g = t.mpv.pe.prs$MPV_PRS_SD 

g0=g[t.mpv.pe.prs$PE==0]

ivmodel.MPV.PE <- glm(t.mpv.pe.prs$PE ~ predict(lm(t.mpv.pe.prs$MPV_initial_SD[t.mpv.pe.prs$PE==0]~g0), newdata=list(g0=g)), family = binomial)

summary(ivmodel.MPV.PE)
summary(ivmodel.MPV.PE)$coef[2] # 2SLS estimate 
summary(ivmodel.MPV.PE)$coef[2,2] # Standard error of 2SLS estimate

