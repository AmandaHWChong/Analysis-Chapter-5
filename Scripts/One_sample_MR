#2SLS analysis 

#Read in relevant packages
library(ivreg)
library(dplyr)

#Read in data
data <- read.table("/projects/MRC-IEU/research/projects/ieu1/wp1/028/working/data/results/UKBB/Phenotypes/Platelet_phenotypes_and_medication/One_sample_MR/IEU_UKBB_plateletphenotypes_acuteMI_mortalityafterMI_DVT_PE_covariates_PC40_withIDS_onesampleMRinput_FINAL", header = T) 

PLT_PRS <- read.table("/projects/MRC-IEU/research/projects/ieu1/wp1/028/working/data/results/UKBB/Phenotypes/Platelet_phenotypes_and_medication/Input/PRS/HaemGen_PLT_PRS_chr1_22_input", header = T) 

MPV_PRS <- read.table("/projects/MRC-IEU/research/projects/ieu1/wp1/028/working/data/results/UKBB/Phenotypes/Platelet_phenotypes_and_medication/Input/PRS/HaemGen_MPV_PRS_chr1_22_input, header = T)

#Subset each exposures of interest with each outcome of interest, plus covariates and PC
t.plt.acuteMI <- data[c("FID", "IID", "PLT_initial_SD", "Acute_MI", "alcintakefreq_initialassessment", "eversmoked_initialassessment", "BMI_initialassessment", "HDL_initialassessment", "LDL_initialassessment", "triglycerides_initialassessment", "sex", "age_initialrecruitment", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "PC21", "PC22", "PC23", "PC24", "PC25", "PC26", "PC27", "PC28", "PC29", "PC30", "PC31", "PC32", "PC33", "PC34", "PC35", "PC36", "PC37", "PC38", "PC39", "PC40")]

t.plt.mortalityMI <- data[c("FID", "IID", "PLT_initial_SD", "Mortality_MI", "alcintakefreq_initialassessment", "eversmoked_initialassessment", "BMI_initialassessment", "HDL_initialassessment", "LDL_initialassessment", "triglycerides_initialassessment", "sex", "age_initialrecruitment", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "PC21", "PC22", "PC23", "PC24", "PC25", "PC26", "PC27", "PC28", "PC29", "PC30", "PC31", "PC32", "PC33", "PC34", "PC35", "PC36", "PC37", "PC38", "PC39", "PC40")]

t.plt.dvt <- data[c("FID", "IID", "PLT_initial_SD", "DVT", "alcintakefreq_initialassessment", "eversmoked_initialassessment", "BMI_initialassessment", "HDL_initialassessment", "LDL_initialassessment", "triglycerides_initialassessment", "sex", "age_initialrecruitment", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "PC21", "PC22", "PC23", "PC24", "PC25", "PC26", "PC27", "PC28", "PC29", "PC30", "PC31", "PC32", "PC33", "PC34", "PC35", "PC36", "PC37", "PC38", "PC39", "PC40")]

t.plt.pe <- data[c("FID", "IID", "PLT_initial_SD", "PE", "alcintakefreq_initialassessment", "eversmoked_initialassessment", "BMI_initialassessment", "HDL_initialassessment", "LDL_initialassessment", "triglycerides_initialassessment", "sex", "age_initialrecruitment", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "PC21", "PC22", "PC23", "PC24", "PC25", "PC26", "PC27", "PC28", "PC29", "PC30", "PC31", "PC32", "PC33", "PC34", "PC35", "PC36", "PC37", "PC38", "PC39", "PC40")]

t.mpv.acuteMI <- data[c("FID", "IID", "MPV_initial_SD", "Acute_MI", "alcintakefreq_initialassessment", "eversmoked_initialassessment", "BMI_initialassessment", "HDL_initialassessment", "LDL_initialassessment", "triglycerides_initialassessment", "sex", "age_initialrecruitment", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "PC21", "PC22", "PC23", "PC24", "PC25", "PC26", "PC27", "PC28", "PC29", "PC30", "PC31", "PC32", "PC33", "PC34", "PC35", "PC36", "PC37", "PC38", "PC39", "PC40")]

t.mpv.mortalityMI <- data[c("FID", "IID", "MPV_initial_SD", "Mortality_MI", "alcintakefreq_initialassessment", "eversmoked_initialassessment", "BMI_initialassessment", "HDL_initialassessment", "LDL_initialassessment", "triglycerides_initialassessment", "sex", "age_initialrecruitment", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "PC21", "PC22", "PC23", "PC24", "PC25", "PC26", "PC27", "PC28", "PC29", "PC30", "PC31", "PC32", "PC33", "PC34", "PC35", "PC36", "PC37", "PC38", "PC39", "PC40")]

t.mpv.dvt <- data[c("FID", "IID", "MPV_initial_SD", "DVT", "alcintakefreq_initialassessment", "eversmoked_initialassessment", "BMI_initialassessment", "HDL_initialassessment", "LDL_initialassessment", "triglycerides_initialassessment", "sex", "age_initialrecruitment", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "PC21", "PC22", "PC23", "PC24", "PC25", "PC26", "PC27", "PC28", "PC29", "PC30", "PC31", "PC32", "PC33", "PC34", "PC35", "PC36", "PC37", "PC38", "PC39", "PC40")]

t.mpv.pe <- data[c("FID", "IID", "MPV_initial_SD", "PE", "alcintakefreq_initialassessment", "eversmoked_initialassessment", "BMI_initialassessment", "HDL_initialassessment", "LDL_initialassessment", "triglycerides_initialassessment", "sex", "age_initialrecruitment", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "PC21", "PC22", "PC23", "PC24", "PC25", "PC26", "PC27", "PC28", "PC29", "PC30", "PC31", "PC32", "PC33", "PC34", "PC35", "PC36", "PC37", "PC38", "PC39", "PC40")]

#Remove NAs from each subsetted dataframe
t.plt.acuteMI <- na.omit(t.plt.acuteMI)
t.plt.mortalityMI <- na.omit(t.plt.mortalityMI)
t.plt.dvt <- na.omit(t.plt.dvt)
t.plt.pe <- na.omit(t.plt.pe)
t.mpv.acuteMI <- na.omit(t.mpv.acuteMI)
t.mpv.mortalityMI <- na.omit(t.mpv.mortalityMI)
t.mpv.dvt <- na.omit(t.mpv.dvt)
t.mpv.pe <- na.omit(t.mpv.pe)

#Match each subsetted dataframe with each PRS 
t.plt.acuteMI.PLTPRS <- inner
t.plt.mortalityMI.PLTPRS <- 
t.plt.dvt.PLTPRS <- 
t.plt.pe.PLTPRS <- 
t.mpv.acuteMI.MPVPRS <- 
t.mpv.mortalityMI.MPVPRS <- 
t.mpv.dvt.MPVPRS <- 
t.mpv.pe.MPVPRS <- 

#Extract names of variables
variables<-names(data)

# Number of X1s plus adjusted covs not PCs
# X1 + X2 + X3 + X4 (4)
# A1 + A2 + A3 (3)  

num.exposures<- 6 + 8

#g is sum of allele scores 
g = PLT_PRS$PLT_PRS 

#Create empty data frame for results
res<-matrix( rep( 0, len= num.exposures^2), nrow = num.exposures)
res.se<-matrix( rep( 0, len= num.exposures^2), nrow = num.exposures)
res.pvalue<-matrix( rep( 0, len= num.exposures^2), nrow = num.exposures)

#Regress each variable on all other variables, saving results
for(i in 1:ncol(res)){
  
  t.outcome<-variables[i]
  
  t.exposure.list<-variables[-i]
     
  t.res<-rep(0,(num.exposures-1))
  
  t.pvalue<-rep(0,(num.exposures-1))
  
  t.se<-rep(0,(num.exposures-1))
     
  for(j in 1:(num.exposures-1)){
    
    t.exposures<-paste(t.exposure.list[j])
    
    t.exposures<-paste(c(t.exposures,variables[(num.exposures-2):length(variables)]))
    
    t.exposures<-unique(t.exposures)
    
    t.exposures<-t.exposures[t.exposures!=t.outcome]
            
    t.exposures<-paste(t.exposures,collapse="+")
    
    t.g=g[t.outcome==0]
    
    if(is.integer(data[,i])){
      
      mod.t<-summary(glm(t.outcome ~ predict(lm(t.exposures[t.outcome==0]~t.g), newdata=list(g0=t.g)), data=data, family="binomial"))
      
      t.res[j]<-mod.t$coefficients[2,1]
      t.se[j]<-mod.t$coefficients[2,2]
      t.pvalue[j]<-mod.t$coefficients[2,4]
      
    }else{
      
      mod.t<-summary(ivreg(t.outcome ~ t.exposures | PLT_PRS$PLT_PRS, x = TRUE))
      
      t.res[j]<-mod.t$coefficients[2,1]
      t.se[j]<-mod.t$coefficients[2,2]
      t.pvalue[j]<-mod.t$coefficients[2,4]
      
    }
    
  }
                         
  #Making 1 on diagonal
  
  if(i == 1){
    
    t.res<-c(1,t.res)
    t.se<-c(1,t.se)
    t.pvalue<-c(1,t.pvalue)
    
  }
  
  if(i == num.exposures){
    
    t.res<-c(t.res,1)
    t.se<-c(t.se,1)
    t.pvalue<-c(t.pvalue,1)
    
  }
  
  if(i != 1 & i != num.exposures){
    
    t.res<-c(t.res[1:(i-1)],1,t.res[i:(num.exposures-1)])
    t.se<-c(t.se[1:(i-1)],1,t.se[i:(num.exposures-1)])
    t.pvalue<-c(t.pvalue[1:(i-1)],1,t.pvalue[i:(num.exposures-1)])
    
  }
  
  #Populating zero matrices
  
  res[,i]<-t.res
  res.se[,i]<-t.se
  res.pvalue[,i]<-t.pvalue
  
}

#Making it look pretty

results<-data.frame(res)

names(results)<-variables[1:num.exposures]

row.names(results)<-variables[1:num.exposures]

se.data<-data.frame(res.se)

names(se.data)<-variables[1:num.exposures]

row.names(se.data)<-variables[1:num.exposures]

pval.data<-data.frame(res.pvalue)

names(pval.data)<-variables[1:num.exposures]

row.names(pval.data)<-variables[1:num.exposures]
