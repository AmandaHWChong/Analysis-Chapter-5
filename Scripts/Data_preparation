###Linking ICD10 codes of interest to ICD10 dates###
#The input will be used to perform the observational and one-sample MR analyses restricted on ICD10 cases of interest that have occurred after the platelet measurements to minimise reverse causation.

##Prepare ICD10 codes of interest 
#Read in relevant packages
library(data.table)
library(plyr)
library(dplyr)

#Read in relevant data
dat <- fread("IEU_output_extracted_plateletphenotypes_SD_41270_ICD10_41280_ICD10dates.tsv", header = T, sep = " ", na.strings = c("","NA"))

#Format date columns to r dates 
dat$f.41280.0.0 <- as.Date(dat$f.41280.0.0)
dat$f.41280.0.1 <- as.Date(dat$f.41280.0.1)
dat$f.41280.0.2 <- as.Date(dat$f.41280.0.2)
dat$f.41280.0.3 <- as.Date(dat$f.41280.0.3)
dat$f.41280.0.4 <- as.Date(dat$f.41280.0.4)
dat$f.41280.0.5 <- as.Date(dat$f.41280.0.5)
dat$f.41280.0.6 <- as.Date(dat$f.41280.0.6)
dat$f.41280.0.7 <- as.Date(dat$f.41280.0.7)
dat$f.41280.0.8 <- as.Date(dat$f.41280.0.8)
dat$f.41280.0.9 <- as.Date(dat$f.41280.0.9)
dat$f.41280.0.10 <- as.Date(dat$f.41280.0.10)
dat$f.41280.0.11 <- as.Date(dat$f.41280.0.11)
dat$f.41280.0.12 <- as.Date(dat$f.41280.0.12)
dat$f.41280.0.13 <- as.Date(dat$f.41280.0.13)
dat$f.41280.0.14 <- as.Date(dat$f.41280.0.14)
dat$f.41280.0.15 <- as.Date(dat$f.41280.0.15)
dat$f.41280.0.16 <- as.Date(dat$f.41280.0.16)
dat$f.41280.0.17 <- as.Date(dat$f.41280.0.17)
dat$f.41280.0.18 <- as.Date(dat$f.41280.0.18)
dat$f.41280.0.19 <- as.Date(dat$f.41280.0.19)
dat$f.41280.0.20 <- as.Date(dat$f.41280.0.20)
dat$f.41280.0.21 <- as.Date(dat$f.41280.0.21)
dat$f.41280.0.22 <- as.Date(dat$f.41280.0.22)
dat$f.41280.0.23 <- as.Date(dat$f.41280.0.23)
dat$f.41280.0.24 <- as.Date(dat$f.41280.0.24)
dat$f.41280.0.25 <- as.Date(dat$f.41280.0.25)
dat$f.41280.0.26 <- as.Date(dat$f.41280.0.26)
dat$f.41280.0.27 <- as.Date(dat$f.41280.0.27)
dat$f.41280.0.28 <- as.Date(dat$f.41280.0.28)
dat$f.41280.0.29 <- as.Date(dat$f.41280.0.29)
dat$f.41280.0.30 <- as.Date(dat$f.41280.0.30)
dat$f.41280.0.31 <- as.Date(dat$f.41280.0.31)
dat$f.41280.0.32 <- as.Date(dat$f.41280.0.32)
dat$f.41280.0.33 <- as.Date(dat$f.41280.0.33)
dat$f.41280.0.34 <- as.Date(dat$f.41280.0.34)
dat$f.41280.0.35 <- as.Date(dat$f.41280.0.35)
dat$f.41280.0.36 <- as.Date(dat$f.41280.0.36)
dat$f.41280.0.37 <- as.Date(dat$f.41280.0.37)
dat$f.41280.0.38 <- as.Date(dat$f.41280.0.38)
dat$f.41280.0.39 <- as.Date(dat$f.41280.0.39)
dat$f.41280.0.40 <- as.Date(dat$f.41280.0.40)
dat$f.41280.0.41 <- as.Date(dat$f.41280.0.41)
dat$f.41280.0.42 <- as.Date(dat$f.41280.0.42)
dat$f.41280.0.43 <- as.Date(dat$f.41280.0.43)
dat$f.41280.0.44 <- as.Date(dat$f.41280.0.44)
dat$f.41280.0.45 <- as.Date(dat$f.41280.0.45)
dat$f.41280.0.46 <- as.Date(dat$f.41280.0.46)
dat$f.41280.0.47 <- as.Date(dat$f.41280.0.47)
dat$f.41280.0.48 <- as.Date(dat$f.41280.0.48)
dat$f.41280.0.49 <- as.Date(dat$f.41280.0.49)
dat$f.41280.0.50 <- as.Date(dat$f.41280.0.50)
dat$f.41280.0.51 <- as.Date(dat$f.41280.0.51)
dat$f.41280.0.52 <- as.Date(dat$f.41280.0.52)
dat$f.41280.0.53 <- as.Date(dat$f.41280.0.53)
dat$f.41280.0.54 <- as.Date(dat$f.41280.0.54)
dat$f.41280.0.55 <- as.Date(dat$f.41280.0.55)
dat$f.41280.0.56 <- as.Date(dat$f.41280.0.56)
dat$f.41280.0.57 <- as.Date(dat$f.41280.0.57)
dat$f.41280.0.58 <- as.Date(dat$f.41280.0.58)
dat$f.41280.0.59 <- as.Date(dat$f.41280.0.59)
dat$f.41280.0.60 <- as.Date(dat$f.41280.0.60)
dat$f.41280.0.61 <- as.Date(dat$f.41280.0.61)
dat$f.41280.0.62 <- as.Date(dat$f.41280.0.62)
dat$f.41280.0.63 <- as.Date(dat$f.41280.0.63)
dat$f.41280.0.64 <- as.Date(dat$f.41280.0.64)
dat$f.41280.0.65 <- as.Date(dat$f.41280.0.65)
dat$f.41280.0.66 <- as.Date(dat$f.41280.0.66)
dat$f.41280.0.67 <- as.Date(dat$f.41280.0.67)
dat$f.41280.0.68 <- as.Date(dat$f.41280.0.68)
dat$f.41280.0.69 <- as.Date(dat$f.41280.0.69)
dat$f.41280.0.70 <- as.Date(dat$f.41280.0.70)
dat$f.41280.0.71 <- as.Date(dat$f.41280.0.71)
dat$f.41280.0.72 <- as.Date(dat$f.41280.0.72)
dat$f.41280.0.73 <- as.Date(dat$f.41280.0.73)
dat$f.41280.0.74 <- as.Date(dat$f.41280.0.74)
dat$f.41280.0.75 <- as.Date(dat$f.41280.0.75)
dat$f.41280.0.76 <- as.Date(dat$f.41280.0.76)
dat$f.41280.0.77 <- as.Date(dat$f.41280.0.77)
dat$f.41280.0.78 <- as.Date(dat$f.41280.0.78)
dat$f.41280.0.79 <- as.Date(dat$f.41280.0.79)
dat$f.41280.0.80 <- as.Date(dat$f.41280.0.80)
dat$f.41280.0.81 <- as.Date(dat$f.41280.0.81)
dat$f.41280.0.82 <- as.Date(dat$f.41280.0.82)
dat$f.41280.0.83 <- as.Date(dat$f.41280.0.83)
dat$f.41280.0.84 <- as.Date(dat$f.41280.0.84)
dat$f.41280.0.85 <- as.Date(dat$f.41280.0.85)
dat$f.41280.0.86 <- as.Date(dat$f.41280.0.86)
dat$f.41280.0.87 <- as.Date(dat$f.41280.0.87)
dat$f.41280.0.88 <- as.Date(dat$f.41280.0.88)
dat$f.41280.0.89 <- as.Date(dat$f.41280.0.89)
dat$f.41280.0.90 <- as.Date(dat$f.41280.0.90)
dat$f.41280.0.91 <- as.Date(dat$f.41280.0.91)
dat$f.41280.0.92 <- as.Date(dat$f.41280.0.92)
dat$f.41280.0.93 <- as.Date(dat$f.41280.0.93)
dat$f.41280.0.94 <- as.Date(dat$f.41280.0.94)
dat$f.41280.0.95 <- as.Date(dat$f.41280.0.95)
dat$f.41280.0.96 <- as.Date(dat$f.41280.0.96)
dat$f.41280.0.97 <- as.Date(dat$f.41280.0.97)
dat$f.41280.0.98 <- as.Date(dat$f.41280.0.98)
dat$f.41280.0.99 <- as.Date(dat$f.41280.0.99)
dat$f.41280.0.100 <- as.Date(dat$f.41280.0.100)
dat$f.41280.0.101 <- as.Date(dat$f.41280.0.101)
dat$f.41280.0.102 <- as.Date(dat$f.41280.0.102)
dat$f.41280.0.103 <- as.Date(dat$f.41280.0.103)
dat$f.41280.0.104 <- as.Date(dat$f.41280.0.104)
dat$f.41280.0.105 <- as.Date(dat$f.41280.0.105)
dat$f.41280.0.106 <- as.Date(dat$f.41280.0.106)
dat$f.41280.0.107 <- as.Date(dat$f.41280.0.107)
dat$f.41280.0.108 <- as.Date(dat$f.41280.0.108)
dat$f.41280.0.109 <- as.Date(dat$f.41280.0.109)
dat$f.41280.0.110 <- as.Date(dat$f.41280.0.110)
dat$f.41280.0.111 <- as.Date(dat$f.41280.0.111)
dat$f.41280.0.112 <- as.Date(dat$f.41280.0.112)
dat$f.41280.0.113 <- as.Date(dat$f.41280.0.113)
dat$f.41280.0.114 <- as.Date(dat$f.41280.0.114)
dat$f.41280.0.115 <- as.Date(dat$f.41280.0.115)
dat$f.41280.0.116 <- as.Date(dat$f.41280.0.116)
dat$f.41280.0.117 <- as.Date(dat$f.41280.0.117)
dat$f.41280.0.118 <- as.Date(dat$f.41280.0.118)
dat$f.41280.0.119 <- as.Date(dat$f.41280.0.119)
dat$f.41280.0.120 <- as.Date(dat$f.41280.0.120)
dat$f.41280.0.121 <- as.Date(dat$f.41280.0.121)
dat$f.41280.0.122 <- as.Date(dat$f.41280.0.122)
dat$f.41280.0.123 <- as.Date(dat$f.41280.0.123)
dat$f.41280.0.124 <- as.Date(dat$f.41280.0.124)
dat$f.41280.0.125 <- as.Date(dat$f.41280.0.125)
dat$f.41280.0.126 <- as.Date(dat$f.41280.0.126)
dat$f.41280.0.127 <- as.Date(dat$f.41280.0.127)
dat$f.41280.0.128 <- as.Date(dat$f.41280.0.128)
dat$f.41280.0.129 <- as.Date(dat$f.41280.0.129)
dat$f.41280.0.130 <- as.Date(dat$f.41280.0.130)
dat$f.41280.0.131 <- as.Date(dat$f.41280.0.131)
dat$f.41280.0.132 <- as.Date(dat$f.41280.0.132)
dat$f.41280.0.133 <- as.Date(dat$f.41280.0.133)
dat$f.41280.0.134 <- as.Date(dat$f.41280.0.134)
dat$f.41280.0.135 <- as.Date(dat$f.41280.0.135)
dat$f.41280.0.136 <- as.Date(dat$f.41280.0.136)
dat$f.41280.0.137 <- as.Date(dat$f.41280.0.137)
dat$f.41280.0.138 <- as.Date(dat$f.41280.0.138)
dat$f.41280.0.139 <- as.Date(dat$f.41280.0.139)
dat$f.41280.0.140 <- as.Date(dat$f.41280.0.140)
dat$f.41280.0.141 <- as.Date(dat$f.41280.0.141)
dat$f.41280.0.142 <- as.Date(dat$f.41280.0.142)
dat$f.41280.0.143 <- as.Date(dat$f.41280.0.143)
dat$f.41280.0.144 <- as.Date(dat$f.41280.0.144)
dat$f.41280.0.145 <- as.Date(dat$f.41280.0.145)
dat$f.41280.0.146 <- as.Date(dat$f.41280.0.146)
dat$f.41280.0.147 <- as.Date(dat$f.41280.0.147)
dat$f.41280.0.148 <- as.Date(dat$f.41280.0.148)
dat$f.41280.0.149 <- as.Date(dat$f.41280.0.149)
dat$f.41280.0.150 <- as.Date(dat$f.41280.0.150)
dat$f.41280.0.151 <- as.Date(dat$f.41280.0.151)
dat$f.41280.0.152 <- as.Date(dat$f.41280.0.152)
dat$f.41280.0.153 <- as.Date(dat$f.41280.0.153)
dat$f.41280.0.154 <- as.Date(dat$f.41280.0.154)
dat$f.41280.0.155 <- as.Date(dat$f.41280.0.155)
dat$f.41280.0.156 <- as.Date(dat$f.41280.0.156)
dat$f.41280.0.157 <- as.Date(dat$f.41280.0.157)
dat$f.41280.0.158 <- as.Date(dat$f.41280.0.158)
dat$f.41280.0.159 <- as.Date(dat$f.41280.0.159)
dat$f.41280.0.160 <- as.Date(dat$f.41280.0.160)
dat$f.41280.0.161 <- as.Date(dat$f.41280.0.161)
dat$f.41280.0.162 <- as.Date(dat$f.41280.0.162)
dat$f.41280.0.163 <- as.Date(dat$f.41280.0.163)
dat$f.41280.0.164 <- as.Date(dat$f.41280.0.164)
dat$f.41280.0.165 <- as.Date(dat$f.41280.0.165)
dat$f.41280.0.166 <- as.Date(dat$f.41280.0.166)
dat$f.41280.0.167 <- as.Date(dat$f.41280.0.167)
dat$f.41280.0.168 <- as.Date(dat$f.41280.0.168)
dat$f.41280.0.169 <- as.Date(dat$f.41280.0.169)
dat$f.41280.0.170 <- as.Date(dat$f.41280.0.170)
dat$f.41280.0.171 <- as.Date(dat$f.41280.0.171)
dat$f.41280.0.172 <- as.Date(dat$f.41280.0.172)
dat$f.41280.0.173 <- as.Date(dat$f.41280.0.173)
dat$f.41280.0.174 <- as.Date(dat$f.41280.0.174)
dat$f.41280.0.175 <- as.Date(dat$f.41280.0.175)
dat$f.41280.0.176 <- as.Date(dat$f.41280.0.176)
dat$f.41280.0.177 <- as.Date(dat$f.41280.0.177)
dat$f.41280.0.178 <- as.Date(dat$f.41280.0.178)
dat$f.41280.0.179 <- as.Date(dat$f.41280.0.179)
dat$f.41280.0.180 <- as.Date(dat$f.41280.0.180)
dat$f.41280.0.181 <- as.Date(dat$f.41280.0.181)
dat$f.41280.0.182 <- as.Date(dat$f.41280.0.182)
dat$f.41280.0.183 <- as.Date(dat$f.41280.0.183)
dat$f.41280.0.184 <- as.Date(dat$f.41280.0.184)
dat$f.41280.0.185 <- as.Date(dat$f.41280.0.185)
dat$f.41280.0.186 <- as.Date(dat$f.41280.0.186)
dat$f.41280.0.187 <- as.Date(dat$f.41280.0.187)
dat$f.41280.0.188 <- as.Date(dat$f.41280.0.188)
dat$f.41280.0.189 <- as.Date(dat$f.41280.0.189)
dat$f.41280.0.190 <- as.Date(dat$f.41280.0.190)
dat$f.41280.0.191 <- as.Date(dat$f.41280.0.191)
dat$f.41280.0.192 <- as.Date(dat$f.41280.0.192)
dat$f.41280.0.193 <- as.Date(dat$f.41280.0.193)
dat$f.41280.0.194 <- as.Date(dat$f.41280.0.194)
dat$f.41280.0.195 <- as.Date(dat$f.41280.0.195)
dat$f.41280.0.196 <- as.Date(dat$f.41280.0.196)
dat$f.41280.0.197 <- as.Date(dat$f.41280.0.197)
dat$f.41280.0.198 <- as.Date(dat$f.41280.0.198)
dat$f.41280.0.199 <- as.Date(dat$f.41280.0.199)
dat$f.41280.0.200 <- as.Date(dat$f.41280.0.200)
dat$f.41280.0.201 <- as.Date(dat$f.41280.0.201)
dat$f.41280.0.202 <- as.Date(dat$f.41280.0.202)
dat$f.41280.0.203 <- as.Date(dat$f.41280.0.203)
dat$f.41280.0.204 <- as.Date(dat$f.41280.0.204)
dat$f.41280.0.205 <- as.Date(dat$f.41280.0.205)
dat$f.41280.0.206 <- as.Date(dat$f.41280.0.206)
dat$f.41280.0.207 <- as.Date(dat$f.41280.0.207)
dat$f.41280.0.208 <- as.Date(dat$f.41280.0.208)
dat$f.41280.0.209 <- as.Date(dat$f.41280.0.209)
dat$f.41280.0.210 <- as.Date(dat$f.41280.0.210)
dat$f.41280.0.211 <- as.Date(dat$f.41280.0.211)
dat$f.41280.0.212 <- as.Date(dat$f.41280.0.212)
dat$f.41280.0.213 <- as.Date(dat$f.41280.0.213)
dat$f.41280.0.214 <- as.Date(dat$f.41280.0.214)
dat$f.41280.0.215 <- as.Date(dat$f.41280.0.215)
dat$f.41280.0.216 <- as.Date(dat$f.41280.0.216)
dat$f.41280.0.217 <- as.Date(dat$f.41280.0.217)
dat$f.41280.0.218 <- as.Date(dat$f.41280.0.218)
dat$f.41280.0.219 <- as.Date(dat$f.41280.0.219)
dat$f.41280.0.220 <- as.Date(dat$f.41280.0.220)
dat$f.41280.0.221 <- as.Date(dat$f.41280.0.221)
dat$f.41280.0.222 <- as.Date(dat$f.41280.0.222)
dat$f.41280.0.223 <- as.Date(dat$f.41280.0.223)
dat$f.41280.0.224 <- as.Date(dat$f.41280.0.224)
dat$f.41280.0.225 <- as.Date(dat$f.41280.0.225)

#Load function
source("UKBexpFunc.R")

#All ICD10 data
allICD10 <- unlist(dat %>% select(starts_with("f.41270.")), use.names=F) #this searches your columns for all unique values and lists them
allICD10<-allICD10[!is.na(allICD10)] # removes NA
allICD10<-allICD10[!duplicated(allICD10)] # removes duplicate ICD10 codes

#Subset for only ICD10 codes of interest 
toMatch <- c("I210", "I211", "I212", "I213", "I214", "I219") #ICD10 codes for acute MI
#OR
toMatch <- c("I801", "I802") #ICD10 codes for DVT
#OR
toMatch <- c("I260", "I269") #ICD10 codes for PE
thrombotic_events_ICD10 <- unique(grep(paste(toMatch,collapse="|"), allICD10, value=TRUE))
thrombotic_events_ICD10 <- as.integer(thrombotic_events_ICD10)
table(thrombotic_events_ICD10) #Check the codes of interest that were matched

#Run function 
res_ICD10cases <- UKBexpFunc(dat= dat, exposureCode = thrombotic_events_ICD10, sitename = "thrombotic.events.ICD10", other=F, exp_col = "f.41270.")
res_ICD10controls <- UKBexpFunc(dat= dat, exposureCode = thrombotic_events_ICD10, sitename = "otherICD10", other=TRUE)
res <- full_join(res_ICD10cases, res_ICD10controls)

# How many diagnosis of ICD10 vars?
ICD10_cases <- res %>% dplyr:: select(starts_with("thrombotic"))
str(df, list.len=ncol(ICD10_cases)) 
ICD10_other <- res %>% dplyr:: select(starts_with("other"))
str(df, list.len=ncol(ICD10_other)) 

ICD10_res <- res %>% select("projectID", "ieu", "PLT_initial_SD", "PLT_dates_initial","MPV_initial_SD", "MPVdates_initial", starts_with("thrombotic.events.ICD10"), start_with("other")) #To match PLT with ICD10 cases
#OR
ICD10_res <- res %>% select("projectID", "ieu", "MPV_initial_SD", "MPVdates_initial", starts_with("thrombotic.events.ICD10"), start_with("other")) # To make MPV to ICD10 

#Format results 
# 1. split the ICD10 diagnoses: #ICD_code/date_of_diagnosis
# 2. format columns
# 3. generate incidence of ICD10 flag
# 4. define controls
# 5. define incident cases
# 6. tidy up data

library(tidyr); library(dplyr)

df <- ICD10_res 
rm(ICD10_res)
df <- as.data.frame(df) 

#Perform step 1 
df2 <-separate(df, thrombotic.events.ICD101, into = c("thrombotic.events.ICD10.1", "thromobtic.events.ICD10.date.diagnosis.1"), sep = "/")
df3 <-separate(df2, thrombotic.events.ICD102, into = c("thrombotic.events.ICD10.2", "thromobtic.events.ICD10.date.diagnosis.2"), sep = "/")
df4 <-separate(df3, thrombotic.events.ICD103, into = c("thrombotic.events.ICD10.3", "thromobtic.events.ICD10.date.diagnosis.3"), sep = "/")
df_split <- separate(df4, thrombotic.events.ICD105, into = c("thrombotic.events.ICD10.5", "thromobtic.events.ICD10.date.diagnosis.5"), sep = "/")

rm(list = c("df2", "df3", "df4"))
str(df, list.len=ncol(df))
str(df_split, list.len=ncol(df_split))

#Perform step 2 
df_split$PLTinitialdates <- as.Date(df_split$PLT_dates_initial)
date <- grepl("date", names(df_split))
df_split[,date] <-lapply(df_split[, date, drop=FALSE], as.Date)

#Step 3
df_split <- df_split %>% mutate(earliest_date = pmin(thromobtic.events.ICD10.date.diagnosis.1, na.rm =T))
df_split$PLTincident.flag <- ifelse(df_split$earliest_date >= df_split$PLTinitialdates,1,0) 
table(df_split$PLTincident.flag)

#Step 4 - Define controls
df_split$controls <- ifelse(
  is.na(df_split$thrombotic.events.ICD10.1) &
    is.na(df_split$thrombotic.events.ICD10.2) &
    is.na(df_split$thrombotic.events.ICD10.3), 
  1,
  0
)
table(df_split$controls)

#Step 5 - Participants who have a ICD10 of interest code diagnosed after PLT initial measurement date
# define incident cases (2=cases)
df_split$cases <- ifelse(df_split$PLTincident.flag ==1, 2, 0) # cases
table(df_split$cases)
#Make incident thrombotic outcome
df_split$incident_thrombotic_events <- NA
df_split$incident_thrombotic_events <- ifelse(df_split$controls==1, 1, ifelse(df_split$cases==2, 2, NA))
table(df_split$incident_thrombotic_events)

#Step 6 
res_final <- df_split[,c("projectID", "ieu", "PLT_initial_SD", "PLT_dates_initial", "incident_thrombotic_events")]
write.table(res_final, "UKB_PLT_initial_SD_ICD10_outcome", sep = " ", col.names=T,row.names=F,quote=F)
#OR
res_final <- df_split[,c("projectID", "ieu", "MPV_initial_SD", "MPVdates_initial", "incident_thrombotic_events")]
write.table(res_final, "UKB_MPV_initial_SD_ICD10_outcome", sep = " ", col.names=T,row.names=F,quote=F)
